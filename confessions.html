document.addEventListener('DOMContentLoaded', function() {
    // Set default sorting
    let currentSort = 'date';
    
    // Load all confessions
    confessionData.getConfessions(function(confessions) {
        displayConfessions(confessionData.sortConfessions(confessions, currentSort));
    });
    
    // Set up real-time updates
    confessionData.onConfessionUpdate(function(confessions) {
        displayConfessions(confessionData.sortConfessions(confessions, currentSort));
    });
    
    // Add event listeners to sort buttons
    document.querySelectorAll('.sort-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // Update active button
            document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Update current sort and reload
            currentSort = this.dataset.sort;
            confessionData.getConfessions(function(confessions) {
                displayConfessions(confessionData.sortConfessions(confessions, currentSort));
            });
        });
    });
    
    // Get confession ID from URL if provided
    const urlParams = new URLSearchParams(window.location.search);
    const confessionId = urlParams.get('id');
    
    if (confessionId) {
        // Scroll to the specific confession and open comments
        setTimeout(() => {
            const confessionCard = document.querySelector(`[data-confession-id="${confessionId}"]`);
            if (confessionCard) {
                confessionCard.scrollIntoView({ behavior: 'smooth' });
                const commentBtn = confessionCard.querySelector('.comment-btn');
                if (commentBtn) {
                    commentBtn.click();
                }
            }
        }, 500);
    }
});

function displayConfessions(confessions) {
    const container = document.getElementById('allConfessions');
    container.innerHTML = '';
    
    // Update confession count
    document.getElementById('confessionCount').textContent = 
        `${confessions.length} confession${confessions.length !== 1 ? 's' : ''}`;
    
    if (confessions.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; background-color: var(--white); border-radius: 12px; box-shadow: var(--shadow);">
                <i class="fas fa-inbox" style="font-size: 48px; color: #d1d5db; margin-bottom: 15px;"></i>
                <h3 style="color: var(--primary-dark); margin-bottom: 10px;">No confessions yet</h3>
                <p style="color: #6b7280;">Be the first to share your thoughts anonymously!</p>
                <a href="index.html" class="btn" style="margin-top: 15px; display: inline-block;">Submit Confession</a>
            </div>
        `;
        return;
    }
    
    confessions.forEach(confession => {
        const card = document.createElement('div');
        card.className = 'confession-card';
        card.setAttribute('data-confession-id', confession.id);
        card.innerHTML = `
            <div class="confession-text">${confession.text}</div>
            <div class="confession-meta">
                <span><i class="fas fa-user-secret"></i> Anonymous</span>
                <span>${confession.date}</span>
            </div>
            <div class="confession-actions">
                <button class="action-btn like-btn ${confession.liked ? 'liked' : ''}" data-id="${confession.id}">
                    <i class="fas fa-heart"></i> <span class="like-count">${confession.likes}</span>
                </button>
                <button class="action-btn comment-btn" data-id="${confession.id}">
                    <i class="fas fa-comment"></i> <span class="comment-count">${confession.comments ? confession.comments.length : 0}</span>
                </button>
                <button class="action-btn share-btn" data-id="${confession.id}">
                    <i class="fas fa-share"></i> Share
                </button>
            </div>
            <div class="comments-section" id="comments-${confession.id}">
                <h3>Comments (${confession.comments ? confession.comments.length : 0})</h3>
                <div class="comments-list">
                    ${(confession.comments ? Object.values(confession.comments).map(comment => `
                        <div class="comment">
                            <div class="comment-meta">
                                <span><i class="fas fa-user-secret"></i> Anonymous</span>
                                <span>${comment.date}</span>
                            </div>
                            <div class="comment-text">${comment.text}</div>
                        </div>
                    `).join('') : '')}
                </div>
                <div class="comment-form">
                    <textarea placeholder="Write your comment anonymously..." id="comment-text-${confession.id}"></textarea>
                    <button class="btn" data-id="${confession.id}">Post Comment</button>
                </div>
            </div>
        `;
        container.appendChild(card);
    });
    
    // Add event listeners to action buttons
    document.querySelectorAll('.like-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const confessionId = this.dataset.id;
            const isLiked = this.classList.contains('liked');
            const newLikes = isLiked ? -1 : 1;
            
            confessionData.updateConfession(confessionId, { 
                likes: firebase.database.ServerValue.increment(newLikes) 
            })
            .then(() => {
                const countElement = this.querySelector('.like-count');
                countElement.textContent = parseInt(countElement.textContent) + newLikes;
                
                if (isLiked) {
                    this.classList.remove('liked');
                } else {
                    this.classList.add('liked');
                }
            })
            .catch(error => {
                showNotification('Error: ' + error.message);
            });
        });
    });
    
    document.querySelectorAll('.comment-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const confessionId = this.dataset.id;
            const commentsSection = document.getElementById(`comments-${confessionId}`);
            
            if (commentsSection.classList.contains('open')) {
                commentsSection.classList.remove('open');
            } else {
                // Close all other comment sections
                document.querySelectorAll('.comments-section').forEach(section => {
                    section.classList.remove('open');
                });
                
                commentsSection.classList.add('open');
            }
        });
    });
    
    document.querySelectorAll('.share-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const url = `${window.location.origin}/confessions.html?id=${this.dataset.id}`;
            navigator.clipboard.writeText(url).then(() => {
                showNotification('Link copied to clipboard!');
            }).catch(() => {
                showNotification('Failed to copy link');
            });
        });
    });
    
    // Add event listeners to comment form buttons
    document.querySelectorAll('.comment-form .btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const confessionId = this.dataset.id;
            const commentText = document.getElementById(`comment-text-${confessionId}`).value.trim();
            
            if (commentText) {
                confessionData.addComment(confessionId, commentText)
                    .then(() => {
                        // Clear the textarea
                        document.getElementById(`comment-text-${confessionId}`).value = '';
                        
                        // Show notification
                        showNotification('Your comment has been posted anonymously!');
                        
                        // The real-time update will refresh the comments
                    })
                    .catch(error => {
                        showNotification('Error: ' + error.message);
                    });
            }
        });
    });
}

function showNotification(message) {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.classList.add('show');
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}
