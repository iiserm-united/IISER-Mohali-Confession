document.addEventListener('DOMContentLoaded', function() {
    // Load top confessions
    confessionData.getTopConfessions(3, function(topConfessions) {
        displayTopConfessions(topConfessions);
    });
    
    // Set up real-time updates for top confessions
    confessionData.onConfessionUpdate(function(confessions) {
        const sorted = confessionData.sortConfessions(confessions, 'popularity').slice(0, 3);
        displayTopConfessions(sorted);
    });
    
    // Handle form submission
    document.getElementById('confessionForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const confessionText = document.getElementById('confessionText').value.trim();
        
        if (confessionText) {
            // Add confession to Firebase
            confessionData.addConfession(confessionText)
                .then(() => {
                    showNotification('Your confession has been submitted anonymously!');
                    document.getElementById('confessionText').value = '';
                })
                .catch(error => {
                    showNotification('Error: ' + error.message);
                });
        }
    });
});

function displayTopConfessions(topConfessions) {
    const container = document.getElementById('topConfessions');
    container.innerHTML = '';
    
    if (topConfessions.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #6b7280;">No confessions yet. Be the first to share!</p>';
        return;
    }
    
    topConfessions.forEach(confession => {
        const card = document.createElement('div');
        card.className = 'confession-card';
        card.innerHTML = `
            <div class="confession-text">${confession.text}</div>
            <div class="confession-meta">
                <span><i class="fas fa-user-secret"></i> Anonymous</span>
                <span>${confession.date}</span>
            </div>
            <div class="confession-actions">
                <button class="action-btn like-btn ${confession.liked ? 'liked' : ''}" data-id="${confession.id}">
                    <i class="fas fa-heart"></i> <span class="like-count">${confession.likes}</span>
                </button>
                <button class="action-btn comment-btn" data-id="${confession.id}">
                    <i class="fas fa-comment"></i> ${confession.comments ? confession.comments.length : 0}
                </button>
                <button class="action-btn share-btn" data-id="${confession.id}">
                    <i class="fas fa-share"></i> Share
                </button>
            </div>
        `;
        container.appendChild(card);
    });
    
    // Add event listeners to action buttons
    document.querySelectorAll('.like-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const confessionId = this.dataset.id;
            const isLiked = this.classList.contains('liked');
            const newLikes = isLiked ? -1 : 1;
            
            confessionData.updateConfession(confessionId, { 
                likes: firebase.database.ServerValue.increment(newLikes) 
            })
            .then(() => {
                const countElement = this.querySelector('.like-count');
                countElement.textContent = parseInt(countElement.textContent) + newLikes;
                
                if (isLiked) {
                    this.classList.remove('liked');
                } else {
                    this.classList.add('liked');
                }
            })
            .catch(error => {
                showNotification('Error: ' + error.message);
            });
        });
    });
    
    document.querySelectorAll('.comment-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            window.location.href = `confessions.html?id=${this.dataset.id}`;
        });
    });
    
    document.querySelectorAll('.share-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const url = `${window.location.origin}/confessions.html?id=${this.dataset.id}`;
            navigator.clipboard.writeText(url).then(() => {
                showNotification('Link copied to clipboard!');
            }).catch(() => {
                showNotification('Failed to copy link');
            });
        });
    });
}

function showNotification(message) {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.classList.add('show');
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}
